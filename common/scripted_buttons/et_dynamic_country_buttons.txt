#############################################
# DYNAMIC COUNTRY FINALIZATION (RECOGNIZED) #
#############################################
et_button_finalize_dynamic_country = {
	# Recognized variant (Puppet)
	name = "et_button_finalize_dynamic_country"
	desc = "et_button_finalize_dynamic_country_desc"

	# Visible either for player (manual builder) or AI (automatic criteria)
	visible = {
		is_country_type = recognized
		OR = {
			# Player path requires builder enabled & at least one marked state they own
			AND = {
				is_player = yes
				has_variable = et_dyn_builder_enabled
				any_scope_state = {
					has_decree = decree_et_mark_state_for_dyn_country
					owner = ROOT
				}
			}

			# AI path: allowed when not the player
			AND = {
				is_player = no
			}
		}
	}

	possible = {
		is_country_type = recognized
		NOT = { is_subject = yes }
		OR = {
			AND = {
				is_player = yes
				has_variable = et_dyn_builder_enabled
				any_scope_state = {
					has_decree = decree_et_mark_state_for_dyn_country
					owner = ROOT
				}
			}

			AND = {
				is_player = no
			}
		}
	}

	effect = {
		# PLAYER PATH (manual marking via decree)
		if = {
			limit = { is_player = yes }

			# Pick a capital among marked states (if any)
			if = {
				limit = {
					any_scope_state = {
						has_decree = decree_et_mark_state_for_dyn_country
						owner = ROOT
					}
				}

				random_scope_state = {
					limit = {
						has_decree = decree_et_mark_state_for_dyn_country
						owner = ROOT
					}
					save_scope_as = et_dyn_country_capital
				}
			}
			else = {
				random_scope_state = {
					limit = {
						has_decree = decree_et_mark_state_for_dyn_country
						owner = ROOT
					}
					save_scope_as = et_dyn_country_capital
				}
			}

			# Mark the decree-selected states for ceding
			every_scope_state = {
				limit = {
					has_decree = decree_et_mark_state_for_dyn_country
					owner = ROOT
				}
				set_variable = dynamic_state_cede
			}
		}
		else = {
			# AI PATH — only when AI improvements are enabled and the country is not at war
			if = {
				limit = { has_game_rule = ai_improvement_enabled is_at_war = no }

				# Clean stale selection variables (only touch states owned by this country)
				every_scope_state = {
					limit = { has_variable = ai_potential_dyn_country_state owner = ROOT }
					remove_variable = ai_potential_dyn_country_state
				}

				every_scope_state = {
					limit = { has_variable = dynamic_state_cede owner = ROOT }
					remove_variable = dynamic_state_cede
				}

				# Mark candidate states (allow single-state splits)
				every_scope_state = {
					# Candidate marks (recognized)
					limit = {
						owner = ROOT
						is_capital = no

						OR = {
							NOT = { has_modifier = recent_state_owner_change }
							market_access < 0.01
						}

						OR = {
							AND = {
								is_homeland_of_country_cultures = ROOT
								OR = { turmoil > 0.70 market_access < 0.01 }
							}

							AND = {
								NOT = { is_homeland_of_country_cultures = ROOT }
								OR = { turmoil > 0.50 market_access < 0.15 }
							}
						}
					}

					set_variable = ai_potential_dyn_country_state
				}

				# Proceed only if there are candidate states
				if = {
					limit = { any_scope_state = { has_variable = ai_potential_dyn_country_state } }

					# Pick capital among candidates owned by this country
					random_scope_state = {
						limit = { has_variable = ai_potential_dyn_country_state owner = ROOT }
						save_scope_as = et_dyn_country_capital
						set_variable = dynamic_state_cede
					}

					# Try culture-based clustering; fallback to adjacency expansion
					et_dyn_country_ai_select_culture_for_cluster = yes

					if = {
						limit = { scope:et_dyn_target_culture = { exists = yes } }
						et_dynamic_country_ai_expand_recognized_culture = yes
					}
					else = {
						et_dynamic_country_ai_expand_recognized = yes
					}

					# Cleanup candidate markers (keep dynamic_state_cede for ceding)
					every_scope_state = {
						limit = { has_variable = ai_potential_dyn_country_state owner = ROOT }
						remove_variable = ai_potential_dyn_country_state
					}
				}
			}
		}

		# Create dynamic country (recognized -> puppet)
		# Only if at least one state marked for cede and a capital exists
		if = {
			limit = {
				any_scope_state = { has_variable = dynamic_state_cede }
				scope:et_dyn_country_capital = { exists = yes }
			}

			create_dynamic_country = {
				origin = root
				capital = scope:et_dyn_country_capital
				tier = principality
				cede_state_trigger = { has_variable = dynamic_state_cede }

				# Normalize identity after creation
				on_created = {
					save_scope_as = et_new_dyn_country
					every_scope_state = {
						limit = { has_variable = dynamic_state_cede owner = ROOT }
						remove_variable = dynamic_state_cede
					}

					et_assign_dominant_identity = yes
				}
			}
		}

		hidden_effect = {
			if = {
				limit = { exists = scope:et_dyn_country_capital.owner }
				create_diplomatic_pact = {
					country = scope:et_dyn_country_capital.owner
					type = puppet
				}
			}
		}

		ai_chance = {
			value = 0
			if = {
				limit = {
					has_game_rule = ai_improvement_enabled
					is_at_war = no
					is_subject = no
					# (cooldown removed)
					# Only if there are significant candidate states
					any_scope_state = {
						limit = {
							owner = ROOT
							is_capital = no

							OR = {
								NOT = { has_modifier = recent_state_owner_change }
								market_access < 0.01
							}

							OR = {
								AND = {
									is_homeland_of_country_cultures = ROOT
									OR = { turmoil > 0.70 market_access < 0.01 }
								}

								AND = {
									NOT = { is_homeland_of_country_cultures = ROOT }
									OR = { turmoil > 0.50 market_access < 0.15 }
								}
							}
						}
					}
				}
				add = 100
			}
		}
	}
}

###############################################
# DYNAMIC COUNTRY FINALIZATION (UNRECOGNIZED) #
###############################################
et_button_finalize_dynamic_country_unrecognized = {
	# Unrecognized variant (Vassal)
	name = "et_button_finalize_dynamic_country_unrecognized"
	desc = "et_button_finalize_dynamic_country_unrecognized_desc"

	possible = {
		is_country_type = unrecognized
		NOT = { is_subject = yes }
		OR = {
			AND = {
				is_player = yes
				has_variable = et_dyn_builder_enabled
				any_scope_state = {
					has_decree = decree_et_mark_state_for_dyn_country
					owner = ROOT
				}
			}

			AND = {
				is_player = no
			}
		}
	}

	effect = {
		# Player manual path
		if = {
			limit = { is_player = yes }

			if = {
				limit = {
					any_scope_state = {
						has_decree = decree_et_mark_state_for_dyn_country
						owner = ROOT
					}
				}

				random_scope_state = {
					limit = { has_decree = decree_et_mark_state_for_dyn_country owner = ROOT }
					save_scope_as = et_dyn_country_capital
				}
			}
			else = {
				random_scope_state = {
					limit = { has_decree = decree_et_mark_state_for_dyn_country owner = ROOT }
					save_scope_as = et_dyn_country_capital
				}
			}

			every_scope_state = {
				limit = { has_decree = decree_et_mark_state_for_dyn_country owner = ROOT }
				set_variable = dynamic_state_cede
			}
		}
		else = {
			# AI auto path adjacency cluster (allow single state)
			if = {
				limit = { has_game_rule = ai_improvement_enabled is_at_war = no }

				# Cleanup (only touch states owned by this country)
				every_scope_state = {
					limit = { has_variable = ai_potential_dyn_country_state owner = ROOT }
					remove_variable = ai_potential_dyn_country_state
				}

				every_scope_state = {
					limit = { has_variable = dynamic_state_cede owner = ROOT }
					remove_variable = dynamic_state_cede
				}

				# Mark candidates (unrecognized)
				every_scope_state = {
					limit = {
						owner = ROOT
						is_capital = no

						OR = {
							NOT = { has_modifier = recent_state_owner_change }
							market_access < 0.01
						}

						OR = {
							AND = {
								is_homeland_of_country_cultures = ROOT
								OR = { turmoil > 0.70 market_access < 0.01 }
							}

							AND = {
								NOT = { is_homeland_of_country_cultures = ROOT }
								OR = { turmoil > 0.50 market_access < 0.15 }
							}
						}
					}

					set_variable = ai_potential_dyn_country_state
				}

				# Proceed only if there are candidate states
				if = {
					limit = { any_scope_state = { has_variable = ai_potential_dyn_country_state } }

					random_scope_state = {
						limit = { has_variable = ai_potential_dyn_country_state owner = ROOT }
						save_scope_as = et_dyn_country_capital
						set_variable = dynamic_state_cede
					}

					# Culture-based clustering attempt
					et_dyn_country_ai_select_culture_for_cluster = yes

					if = {
						limit = { scope:et_dyn_target_culture = { exists = yes } }
						et_dynamic_country_ai_expand_unrecognized_culture = yes
					}
					else = {
						et_dynamic_country_ai_expand_unrecognized = yes
					}

					# Cleanup candidate markers
					every_scope_state = {
						limit = { has_variable = ai_potential_dyn_country_state owner = ROOT }
						remove_variable = ai_potential_dyn_country_state
					}
				}
			}
		}

		# Create dynamic country (unrecognized -> vassal)
		if = {
			limit = {
				any_scope_state = { has_variable = dynamic_state_cede }
				scope:et_dyn_country_capital = { exists = yes }
			}

			create_dynamic_country = {
				origin = root
				tier = principality
				capital = scope:et_dyn_country_capital
				cede_state_trigger = { has_variable = dynamic_state_cede }

				on_created = {
					save_scope_as = et_new_dyn_country
					every_scope_state = {
						limit = { has_variable = dynamic_state_cede owner = ROOT }
						remove_variable = dynamic_state_cede
					}

					et_assign_dominant_identity = yes
				}
			}
		}

		hidden_effect = {
			if = {
				limit = { exists = scope:et_dyn_country_capital.owner }
				create_diplomatic_pact = {
					country = scope:et_dyn_country_capital.owner
					type = vassal
				}
			}
		}

		ai_chance = {
			value = 0
			if = {
				limit = {
					has_game_rule = ai_improvement_enabled
					is_at_war = no
					is_subject = no
					# (cooldown removed)
					# Only if there are significant candidate states
					any_scope_state = {
						limit = {
							owner = ROOT
							is_capital = no

							OR = {
								NOT = { has_modifier = recent_state_owner_change }
								market_access < 0.01
							}

							OR = {
								AND = {
									is_homeland_of_country_cultures = ROOT
									OR = { turmoil > 0.70 market_access < 0.01 }
								}

								AND = {
									NOT = { is_homeland_of_country_cultures = ROOT }
									OR = { turmoil > 0.50 market_access < 0.15 }
								}
							}
						}
					}
				}
				add = 100
			}
		}
	}
}
et_button_enable_builder = {
	name = "et_button_enable_builder"
	desc = "et_button_enable_builder_desc"
	visible = { is_player = yes }
	possible = { NOT = { has_variable = et_dyn_builder_enabled } }
	effect = { set_variable = et_dyn_builder_enabled }
	ai_chance = { value = 0 }
}

et_button_disable_builder = {
	name = "et_button_disable_builder"
	desc = "et_button_disable_builder_desc"
	visible = { is_player = yes }
	possible = { has_variable = et_dyn_builder_enabled }
	effect = {
		remove_variable = et_dyn_builder_enabled
	}
	ai_chance = { value = 0 }
}

et_button_authority_cheat_enable = {
	name = "et_button_authority_cheat_enable"
	desc = "et_button_authority_cheat_enable_desc"
	visible = {
		is_player = yes
		NOT = { has_variable = et_authority_cheat_enabled }
	}
	possible = {
		NOT = { has_variable = et_authority_cheat_enabled }
	}
	effect = {
		add_modifier = et_authority_cheat
		set_variable = et_authority_cheat_enabled
	}
	ai_chance = { value = 0 }
}

et_button_authority_cheat_disable = {
	name = "et_button_authority_cheat_disable"
	desc = "et_button_authority_cheat_disable_desc"
	visible = {
		is_player = yes
		has_variable = et_authority_cheat_enabled
	}
	possible = {
		has_variable = et_authority_cheat_enabled
	}
	effect = {
		remove_modifier = et_authority_cheat
		remove_variable = et_authority_cheat_enabled
	}
	ai_chance = { value = 0 }
}