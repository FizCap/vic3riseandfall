#############################################
# Dynamic Identity (Culture & Religion Pick) #
# Heuristic inspired by dynamic cultures mod #
#############################################

# et_assign_dominant_identity
# Scope: country (new dynamic country just created) with transferred ceded states.
# Culture approach: descending national share thresholds, fallback to capital homeland, then any primary.
# Religion approach: descending national share thresholds, fallback to capital sample pop.
# NOTE: Engine lacks a direct 'set_country_religion' effect; we only identify majority for potential future use.

et_assign_dominant_identity = {
    # CULTURE SELECTION ----------------------------------------
    random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.60 } } } save_scope_as = et_new_primary_culture }
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.55 } } } save_scope_as = et_new_primary_culture } }
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.50 } } } save_scope_as = et_new_primary_culture } }
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.45 } } } save_scope_as = et_new_primary_culture } }
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.40 } } } save_scope_as = et_new_primary_culture } }
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.35 } } } save_scope_as = et_new_primary_culture } }
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.30 } } } save_scope_as = et_new_primary_culture } }
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.25 } } } save_scope_as = et_new_primary_culture } }
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.20 } } } save_scope_as = et_new_primary_culture } }

    # Fallback: capital homeland culture
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } capital = { state_region = { random_scope_culture = { limit = { has_homeland = PREV } save_scope_as = et_new_primary_culture } } } }
    # Fallback: any existing primary
    if = { limit = { NOT = { scope:et_new_primary_culture = { exists = yes } } } random_primary_culture = { save_scope_as = et_new_primary_culture } }

    if = {
        limit = { scope:et_new_primary_culture = { exists = yes } }
        # Robust removal: iterate primaries, remove each explicitly from ROOT
        every_primary_culture = {
            save_scope_as = et_old_primary
            ROOT = { remove_primary_culture = scope:et_old_primary }
        }
        add_primary_culture = scope:et_new_primary_culture
    }
}
