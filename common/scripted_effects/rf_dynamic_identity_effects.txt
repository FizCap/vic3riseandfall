#############################################
# Dynamic Identity (Culture & Religion Pick) #
# Heuristic inspired by dynamic cultures mod #
#############################################

# rf_assign_dominant_identity
# Scope: country (new dynamic country just created) with transferred ceded states.
# Culture approach: descending national share thresholds, fallback to capital homeland, then any primary.

rf_assign_dominant_identity = {
    set_variable = { name = newly_formed_country value = yes days = 90 }
    set_variable = { name = newly_formed_country_cooldown value = yes days = 7 }
    # CULTURE SELECTION ----------------------------------------
    random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.60 } } } save_scope_as = rf_new_primary_culture }
    if = { limit = { scope:rf_new_primary_culture = { exists = yes } } ROOT = { set_variable = { name = rf_new_primary_culture_found value = yes } } }
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.55 } } } save_scope_as = rf_new_primary_culture } ROOT = { if = { limit = { scope:rf_new_primary_culture = { exists = yes } } set_variable = { name = rf_new_primary_culture_found value = yes } } } }
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.50 } } } save_scope_as = rf_new_primary_culture } ROOT = { if = { limit = { scope:rf_new_primary_culture = { exists = yes } } set_variable = { name = rf_new_primary_culture_found value = yes } } } }
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.45 } } } save_scope_as = rf_new_primary_culture } ROOT = { if = { limit = { scope:rf_new_primary_culture = { exists = yes } } set_variable = { name = rf_new_primary_culture_found value = yes } } } }
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.40 } } } save_scope_as = rf_new_primary_culture } ROOT = { if = { limit = { scope:rf_new_primary_culture = { exists = yes } } set_variable = { name = rf_new_primary_culture_found value = yes } } } }
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.35 } } } save_scope_as = rf_new_primary_culture } ROOT = { if = { limit = { scope:rf_new_primary_culture = { exists = yes } } set_variable = { name = rf_new_primary_culture_found value = yes } } } }
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.30 } } } save_scope_as = rf_new_primary_culture } ROOT = { if = { limit = { scope:rf_new_primary_culture = { exists = yes } } set_variable = { name = rf_new_primary_culture_found value = yes } } } }
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.25 } } } save_scope_as = rf_new_primary_culture } ROOT = { if = { limit = { scope:rf_new_primary_culture = { exists = yes } } set_variable = { name = rf_new_primary_culture_found value = yes } } } }
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } random_scope_culture = { limit = { ROOT = { culture_percent_country = { target = PREV value >= 0.20 } } } save_scope_as = rf_new_primary_culture } ROOT = { if = { limit = { scope:rf_new_primary_culture = { exists = yes } } set_variable = { name = rf_new_primary_culture_found value = yes } } } }

    # Fallback: capital homeland culture
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } capital = { state_region = { random_scope_culture = { limit = { has_homeland = PREV } save_scope_as = rf_new_primary_culture } } } }
    # Fallback: any existing primary
    if = { limit = { NOT = { has_variable = rf_new_primary_culture_found } } random_primary_culture = { save_scope_as = rf_new_primary_culture } }

    if = {
        limit = { has_variable = rf_new_primary_culture_found }
        # Robust removal: iterate primaries, remove each explicitly from ROOT
        every_primary_culture = {
            save_scope_as = rf_old_primary
            ROOT = { remove_primary_culture = scope:rf_old_primary }
        }
        add_primary_culture = scope:rf_new_primary_culture
    }
    # Cleanup temp marker
    ROOT = { remove_variable = rf_new_primary_culture_found }
    # Kill the ruler of the country
    ruler = { kill_character = yes }

    # RELIGION SELECTION ----------------------------------------
    # Choose a religion from a random pop of the primary culture
    random_scope_pop = {
        # Choose a sample pop located in a state owned by the newly created country
        # (use `state` not `location` ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Â `location` isn't a valid trigger here).
        limit = { state = { owner = ROOT } culture = scope:rf_new_primary_culture }
        save_scope_as = rf_random_pop
    }

    if = {
        limit = { scope:rf_random_pop = { exists = yes } }
        scope:rf_random_pop = {
            religion = { save_scope_as = rf_new_state_religion }
        }
        set_state_religion = scope:rf_new_state_religion
    }
}